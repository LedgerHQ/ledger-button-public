import { hexaStringToBuffer } from "@ledgerhq/device-management-kit";
import { SignerEthBuilder } from "@ledgerhq/device-signer-kit-ethereum";
import { type Factory, inject, injectable } from "inversify";
import { lastValueFrom } from "rxjs";
import { keccak256 } from "viem";

import { loggerModuleTypes } from "../../logger/loggerModuleTypes.js";
import { LoggerPublisher } from "../../logger/service/LoggerPublisher.js";
import { deviceModuleTypes } from "../deviceModuleTypes.js";
import type { DeviceManagementKitService } from "../service/DeviceManagementKitService.js";

export interface TransactionData {
  to: string;
  value: string;
  data?: string;
  chainId: number;
  gasLimit?: string;
  gasPrice?: string;
  maxFeePerGas?: string;
  maxPriorityFeePerGas?: string;
  nonce?: number;
  type?: number | "legacy" | "eip2930" | "eip1559";
}

export interface SignedTransaction {
  hash: string;
  signature: {
    v: number;
    r: string;
    s: string;
  };
  rawTransaction: string;
}

@injectable()
export class SignTransaction {
  private readonly logger: LoggerPublisher;

  constructor(
    @inject(loggerModuleTypes.LoggerPublisher)
    loggerFactory: Factory,
    @inject(deviceModuleTypes.DeviceManagementKitService)
    private readonly deviceManagementKitService: DeviceManagementKitService,
  ) {
    this.logger = loggerFactory("[SignTransaction]");
  }

  async execute(transactionData: TransactionData): Promise {
    this.logger.info("Starting transaction signing", { transactionData });

    const sessionId = this.deviceManagementKitService.sessionId;
    if (!sessionId) {
      this.logger.error("No device connected");

      throw new Error("No device connected. Please connect a device first.");
    }

    const device = this.deviceManagementKitService.connectedDevice;

    if (!device) {
      this.logger.error("No connected device found");

      throw new Error("No connected device found");
    }

    try {
      const dmk = this.deviceManagementKitService.dmk;
      const derivationPath = "44'/60'/0'/0/0"; // Ethereum derivation path
      const ethSigner = new SignerEthBuilder({
        dmk,
        originToken:
          "1e55ba3959f4543af24809d9066a2120bd2ac9246e626e26a1ff77eb109ca0e5",
        sessionId,
      }).build();
      const rawTx =
        "0x02f910dd01808303bd0884253203b383102f1294111111125421ca6dc452d289314280a0f8842a658901c89447b0365a0000b9106807ed23790000000000000000000000005141b82f5ffda4c6fe1e372978f1c5427640a190000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000005141b82f5ffda4c6fe1e372978f1c5427640a190000000000000000000000000feefc512f2311f513ee2a54048809a16e3f40f83000000000000000000000000000000000000000000000001c89447b0365a00000000000000000000000000000000000000000000000000000000001be907e72a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000f17000000000000000000000000000000000000000ef9000ecb000e81000e6700a0c9e75c4800000000000000006464000000000000000000000000000000000000000000000000000e390007bb00a007e5c0d20000000000000000000000000000000000000000000007970006e70006cd00a0c9e75c480000000021200b00021600000000000000000000000000069f0006500006010005b200059800047c416066a9893cc07d91d95644aedd05d03f95e1dba8af02e424856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030dd31b540000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000005141b82f5ffda4c6fe1e372978f1c5427640a190000000000000000000000000000000000000000000000000000000000000000041729995855c00494d039ab6792f18e368e530dff93100841d8a79620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000d1b71758e21960000137e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400065a8177fae27000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000471b64fd4041c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2d0e30db002a00000000000000000000000000000000000000000000000000000000186fabb4bee63c1e5016ca298d2983ab03aa1da7679389d955a4efee15cc02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a0000000000000000000000000000000000000000000000000000000047173425cee63c1e501c7bbec68d12a0d1830360f8ec58fa599ba1b0e9bc02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a00000000000000000000000000000000000000000000000000000000494b3c173ee63c1e50111b815efb8f581194ae79006d24e0d814b7697f6c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20020d6bdbf78dac17f958d2ee523a2206206994597c13d831ec75120ea734b615888c669667038d11950f44b177f15c0dac17f958d2ee523a2206206994597c13d831ec700242668dfaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000de2c1fc080000000000000000000000005141b82f5ffda4c6fe1e372978f1c5427640a19000a0c9e75c480000000000411600020b0000000000000000000000000000000006500006010005b200059800047c416066a9893cc07d91d95644aedd05d03f95e1dba8af02e424856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000186fb68f90000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000005141b82f5ffda4c6fe1e372978f1c5427640a190000000000000000000000000000000000000000000000000000000000000000041729995855c00494d039ab6792f18e368e530dff93100841d8a79620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000d1b71758e21960000137e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400065a8177fae27000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000471915f94041c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2d0e30db002a0000000000000000000000000000000000000000000000000000000030e2a3f99ee63c1e500e0554a476a092703abdb3ef35c80e0d76d32939fc02aaa39b223fe8d0a0e5c4f27ead9083c756cc202a000000000000000000000000000000000000000000000000000000009067c2cd4ee63c1e50088e6a0c2ddd26feeb64f039a2c41296fcb3f5640c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20020d6bdbf78a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800a0f2fa6b66a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000001c0cef8020000000000000000000000000004bedc180a06c4eca27a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48111111125421ca6dc452d289314280a0f8842a65000000000000000000e26b9977c080a0400687db098d4a2421e515ad12fd72241a7b5336e447fbab5835a9ab55a7416ca0798296d7bb0ea84131da33e15a01a01e9d0745f5dd4ab23fa7157468e51c072c";
      const tx = hexaStringToBuffer(rawTx);

      if (!tx) {
        throw Error("No transaction");
      }

      const { observable } = ethSigner.signTransaction(derivationPath, tx);

      const result = await lastValueFrom(observable);

      this.logger.info("Transaction signing completed", { result });

      return {
        hash: keccak256(tx),
        signature: {
          v: result.output.v,
          r: result.output.r,
          s: result.output.s,
        },
        rawTransaction: rawTx,
      };
    } catch (error) {
      this.logger.error("Failed to sign transaction", { error });

      throw new Error(`Transaction signing failed: ${error}`);
    }
  }
}
